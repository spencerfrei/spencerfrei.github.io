---
title: "Visualizations III"
subtitle: "<br><br> STA35B: Statistical Data Science 2"
author: "Spencer Frei"
output:
  xaringan::moon_reader:
    # lib_dir: libs
    nature:
      ratio: "16:9"
      # highlightLines: true
      # highlightStyle: solarized-light
      countIncrementalSlides: false
---
  


  
```{r packages, echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(unvotes)
library(knitr)

hook_output <- knit_hooks$get("output")
knit_hooks$set(output = function(x, options) {
  lines <- options$output.lines
  if (is.null(lines)) {
    return(hook_output(x, options))  # pass to default hook
  }
  x <- unlist(strsplit(x, "\n"))
  more <- "..."
  if (length(lines)==1) {        # first n lines
    if (length(x) > lines) {
      # truncate the output, but add ....
      x <- c(head(x, lines), more)
    }
  } else {
    x <- c(more, x[lines], more)
  }
  # paste these lines together
  x <- paste(c(x, ""), collapse = "\n")
  hook_output(x, options)
})

knitr::opts_chunk$set(comment = NA) # makes it so the ## doesnt appear in output for chunks

source("../_common.R")
```


### Further inspecting diamond prices
* Recall that it appeared that diamond prices seemed inversely correlated with quality
```{r}
#| fig-alt: 
#| fig-width: 4

ggplot(diamonds, aes(x = cut, y = price)) +
  geom_boxplot()
```
* What might be responsible for this? Recall variables: x,y,z refer to length/width/depth of diamond in mm
```{r}
colnames(diamonds)
```

* Let's look at **size** vs price.


---

### Size vs. price in diamonds
* We can try doing 3 side-by-side plots by just doing 3 ggplots:
```{r}
#| layout-ncol: 3
#| fig-width: 3.5
ggplot(diamonds, aes(x = x, y = price)) +
  geom_point()
ggplot(diamonds, aes(x = y, y = price)) +
  geom_point()
ggplot(diamonds, aes(x = z, y = price)) +
  geom_point()
```
* Some things we notice:
  * Clearly some outliers - "zero" length / width / depth diamonds apparently?
  * But still some positive correlation between x, y, z and price
  * Hard to see with so many dots
* Let's use `alpha=` to add some transparency, make it easier on the eyes

---

### Size vs. price in diamonds
* We can try doing 3 side-by-side plots by just doing 3 ggplots:
```{r}
#| layout-ncol: 3
#| fig-width: 3.5
ggplot(diamonds, aes(x = x, y = price)) +
  geom_point(alpha = 0.02)
ggplot(diamonds, aes(x = y, y = price)) +
  geom_point(alpha = 0.02)
ggplot(diamonds, aes(x = z, y = price)) +
  geom_point(alpha = 0.02)
```
* Some things we notice:
  * Clearly some outliers - "zero" length / width / depth diamonds apparently?
  * But still some positive correlation between x, y, z and price
  * Hard to see with so many dots
* Let's now clean up the tibble so we are only looking at the middle 95% of values for x, y, z

---

### Size vs. price in diamonds
* Let's clean up the tibble so we are only looking at the middle 95% of values for x, y, z
```{r}
#| layout-ncol: 3
#| fig-width: 4
diamonds_middle <- diamonds %>%
  filter(between(x, quantile(diamonds$x, 0.025), quantile(diamonds$x, 0.975)),
         between(y, quantile(diamonds$y, 0.025), quantile(diamonds$y, 0.975)),
         between(z, quantile(diamonds$z, 0.025), quantile(diamonds$z, 0.975)))
ggplot(diamonds_middle, aes(x = x, y = price)) +
  geom_point(alpha = 0.02)
ggplot(diamonds_middle, aes(x = y, y = price)) +
  geom_point(alpha = 0.02)
ggplot(diamonds_middle, aes(x = z, y = price)) +
  geom_point(alpha = 0.02)
```

---
### Size vs. price in diamonds
* Appears x, y, z (length/width/depth) are highly correlated with price
* Recall that volume of a cube is length * width * depth - so let's look at the relationship between estimated volume (x\*y\*z) and price
```{r}
#| layout-ncol: 1
#| fig-width: 5
diamonds_middle %>%
  mutate(est_volume = x*y*z) %>%
  ggplot(aes(x = est_volume, y = price)) +
  geom_point(alpha = 0.01)
```
* Does appear to be a strong correlation.
* Now let's think again as to why it was that we previously found that higher quality diamonds were cheaper.

---
### Size vs. price in diamonds
* Hypothesis: higher quality diamonds are smaller, lower quality diamonds are larger.
* To investigate, we could use boxplot: we want to visualize variation in size for each category of quality
.pull-left[ 
```{r}
diamonds_middle %>%
  mutate(est_volume = x*y*z) %>%
  ggplot(aes(x = cut, y = est_volume)) +
  geom_boxplot()
```

]

---

### Size vs price in diamonds
* Let's try to visualize the different cuts on the dot plot:
```{r}
#| layout-ncol: 2
#| fig-width: 5
diamonds_middle %>%
  mutate(est_volume = x*y*z) %>%
  ggplot(aes(x = est_volume, y = price, color = cut)) +
  geom_point(alpha = 0.5)
diamonds_middle %>%
  mutate(est_volume = x*y*z) %>%
  ggplot(aes(x = est_volume, y = price, color = cut)) +
  geom_smooth()
```


---

### Size vs. price in diamonds
* We were looking at the estimated volume, but could also look at the *weight*: carat.  
* Let's see how if weight varies by class.
.pull-left[ 
```{r}
#| layout-ncol: 1
#| fig-width: 4
diamonds %>%
  ggplot(aes(x = cut, y = carat)) +
  geom_boxplot()
```
]

.pull-right[
* Again appears to be a lot of outliers; let's look at middle 95%.
```{r}
#| layout-ncol: 1
#| fig-width: 4
diamonds_middle <- diamonds %>%
  filter(between(carat, quantile(carat, 0.025), quantile(carat, 0.975)))
diamonds_middle %>%
  ggplot(aes(x = cut, y = carat)) +
  geom_boxplot()
```

]
---
### Size vs price in diamonds 
.pull-left[ 
* And now let's visualize relationship between carat size and price by cut:
```{r, echo=FALSE, message=FALSE}
#| layout-ncol: 1
#| fig-width: 4.5
diamonds_middle %>%
  ggplot(aes(x = carat, y = price, color = cut)) +
  geom_point(alpha = 0.5, show.legend=FALSE)
diamonds_middle %>%
  mutate(est_volume = x*y*z) %>%
  ggplot(aes(x = carat, y = price, color = cut)) +
  geom_smooth()
```
]
.pull-right[
* Compare this to what happens if we didn't ignore outliers!
```{r, echo=FALSE, message=FALSE}
#| layout-ncol: 1
#| fig-width: 4.5
diamonds %>%
  ggplot(aes(x = carat, y = price, color = cut)) +
  geom_point(alpha = 0.5, show.legend=FALSE)
diamonds %>%
  mutate(est_volume = x*y*z) %>%
  ggplot(aes(x = carat, y = price, color = cut)) +
  geom_smooth()
```

]

---

### Communicating ideas
* Now we'll look at how to best display data once we've figured out some meaningful relationships between things
* Packages we'll be using: `tidyverse`, `scales`, `ggrepel`, `patchwork`
```{r, echo=FALSE,message=FALSE}
library(tidyverse)
library(scales)
library(ggrepel)
library(patchwork)
```
.pull-left[
* Good labels are crucial to good figures:
```{r, eval = FALSE}
ggplot(mpg, aes(x = displ, y = hwy)) +
  geom_point(aes(color = class)) +
  geom_smooth(se = FALSE) +
  labs(
    x = "Engine displacement (L)",
    y = "Highway fuel economy (mpg)",
    color = "Car type",
    title = "Fuel efficiency generally decreases with engine size",
    subtitle = "Two seaters (sports cars) are an exception because of their light weight",
    caption = "Data from fueleconomy.gov"
  )
```

]

.pull-right[
```{r, echo=FALSE, message=FALSE}
#| fig-width: 5.5
ggplot(mpg, aes(x = displ, y = hwy)) +
  geom_point(aes(color = class)) +
  geom_smooth(se = FALSE) +
  labs(
    x = "Engine displacement (L)",
    y = "Highway fuel economy (mpg)",
    color = "Car type",
    title = "Fuel efficiency generally decreases with engine size",
    subtitle = "Two seaters (sports cars) are an exception because of their light weight",
    caption = "Data from fueleconomy.gov"
  )
```

]
