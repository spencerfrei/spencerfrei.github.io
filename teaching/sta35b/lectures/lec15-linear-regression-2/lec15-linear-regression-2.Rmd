---
title: "Functions and Intro to Linear Regression"
subtitle: "<br><br> STA35B: Statistical Data Science 2"
author: "Spencer Frei"
output:
  xaringan::moon_reader:
    # lib_dir: libs
    nature:
      ratio: "16:9"
      # highlightLines: true
      # highlightStyle: solarized-light
      countIncrementalSlides: false
---
  


  
```{r packages, echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(unvotes)
library(knitr)
library(broom)
library(patchwork)
library(ggpubr)
library(scales) # label_dollar 
library(quantreg) # rq
library(kableExtra)
library(openintro)

hook_output <- knit_hooks$get("output")
knit_hooks$set(output = function(x, options) {
  lines <- options$output.lines
  if (is.null(lines)) {
    return(hook_output(x, options))  # pass to default hook
  }
  x <- unlist(strsplit(x, "\n"))
  more <- "..."
  if (length(lines)==1) {        # first n lines
    if (length(x) > lines) {
      # truncate the output, but add ....
      x <- c(head(x, lines), more)
    }
  } else {
    x <- c(more, x[lines], more)
  }
  # paste these lines together
  x <- paste(c(x, ""), collapse = "\n")
  hook_output(x, options)
})

knitr::opts_chunk$set(comment = NA) # makes it so the ## doesnt appear in output for chunks

source("../_common.R")
```

### Linear regression with multiple predictors
.pull-left[
* Multiple regression extends single predictor regression to setting where there's still a single response but multiple predictors:
$$ y = b_0 + b_1 x_1 + \cdots + b_n x_n.$$
* Data: `loans_full_schema` data with tidying
```{r}
loans <- loans_full_schema |>
  mutate(
    credit_util = total_credit_utilized / total_credit_limit,
    bankruptcy  = as.factor(if_else(public_record_bankrupt == 0, 0, 1)),
    verified_income = droplevels(verified_income)
    ) |>
  rename(credit_checks = inquiries_last_12m) |>
  select(interest_rate, verified_income, debt_to_income, credit_util, bankruptcy, term, credit_checks, issue_month)
```

```{r}
#| label: loans-n-rows-to-show
#| include: false

n_rows_to_show <- 6
n_rows_to_show_string <- "six"
```

```{r}
#| label: tbl-loans-data-matrix
#| echo: false
loans |>
  slice_head(n = 2) |>
  kbl(
    linesep = "", booktabs = TRUE,
    align = "rlrrrr"
  ) |>
  kable_styling(
    bootstrap_options = c("striped", "condensed"),
    latex_options = c("striped", "scale_down", "hold_position"),
    full_width = FALSE
  )

```
]

.pull-right[

```{r}
#| label: tbl-loans-variables
loans_var_def <- tribble(
  ~variable,         ~description,
  "interest_rate",   "Interest rate on the loan, annual percentage.",
  "verified_income", "Categorical var: whether the borrower's income source/amount have been verified",
  "debt_to_income",  "total debt of the borrower divided by their total income.",
  "credit_util",     "what fraction of credit they utilizing",
  "bankruptcy",      "Indicator 0/1: whether the borrower has a past bankruptcy in their record",
  "term",            "The length of the loan, in months.",
  "issue_month",     "The month and year the loan was issued", 
  "credit_checks",   "Number of credit checks in the last 12 months",
)
```

]

---

### Indicators and categorical variables
.pull-left[
* We saw previously how to fit a linear regression model with a single predictor, e.g.

$$
\widehat{\texttt{interest\_rate}} = b_0 + b_1 \times \texttt{bankruptcy}
$$
* Bankruptcy is 0 if no history of bankruptcy, 1 if there is
* Let's inspect the least-squares linear model resulting from this

```{r}

m_bankruptcy <- lm(interest_rate ~ bankruptcy, data = loans)
m_bankruptcy |>
  tidy()
```
* Slope of 0.74 means model predicts 0.74% higher interest rate for those w/ bankruptcy
]

.pull-right[
* Let's now consider a 3-level categorical variable like `verified_income`:
```{r}
loans$verified_income %>% levels 
m_verifincome <- lm(interest_rate ~ verified_income, data = loans)
m_verifincome %>% tidy()
```
* Each row represents the relative difference for each level of verified income
* The level "Not Verified" is missing - this is because it is the **reference level**, default level that other levels are measured against
]

---


### Indicators and categorical variables
.pull-left[
```{r}
m_verifincome %>% tidy()
```
* The equation for the regresion model can be written as: 

$$
\begin{aligned}
\widehat{\texttt{interest_rate}} &= 11.10 \\
&+ 1.42 \times \texttt{verified_income}_{\texttt{Source Verified}} \\
&+ 3.25 \times \texttt{verified_income}_{\texttt{Verified}}
\end{aligned}
$$
* When `verified_income` takes value `Not Verified`, then both indicator functions in the equation for the linear model are set to 0:

$$
\widehat{\texttt{interest_rate}} = 11.10 + 1.42 \times 0 + 3.25 \times 0 = 11.10
$$
]

.pull-right[

* Average interest rate for these borrowers is 11.1%.
* When `verified_income` takes value `Source Verified`, then the corresponding variable takes a value of 1 while the other is 0:

$$
\widehat{\texttt{interest\_rate}} = 11.10 + 1.42 \times 1 + 3.25 \times 0 = 12.52
$$

* Average interest rate for these borrowers is 12.52%.
]
